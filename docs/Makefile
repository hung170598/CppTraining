1. Cáº¥u hÃ¬nh cÃ¡c toolchain vÃ  options make
CC          := arm-none-eabi-gcc
OBJCOPY     := arm-none-eabi-objcopy
MACH        := cortex-m3


CC: chá»n compiler cho ARM (dÃ²ng STM32).

OBJCOPY: dÃ¹ng Ä‘á»ƒ convert .elf â†’ .bin.

MACH: Ä‘áº·t tÃªn kiáº¿n trÃºc CPU Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng trong flags.



ğŸ”§ 2. Compiler vÃ  Linker flags make

CFLAGS := -Ilib -mcpu=$(MACH) -mthumb -mfloat-abi=soft -Wall -O0
-Ilib: include thÆ° má»¥c lib Ä‘á»ƒ tÃ¬m cÃ¡c header files.

-mcpu=cortex-m3: CPU target lÃ  Cortex-M3 (dÃ²ng STM32F1).

-mthumb: compile cháº¿ Ä‘á»™ Thumb (chuáº©n cá»§a STM32).

-mfloat-abi=soft: khÃ´ng dÃ¹ng FPU (há»£p lÃ½ cho STM32F1).

-Wall: báº­t táº¥t cáº£ warning.

-O0: khÃ´ng tá»‘i Æ°u, phÃ¹ há»£p khi Ä‘ang debug.


LDFLAGS := -nostdlib -mcpu=$(MACH) -mthumb -mfloat-abi=soft --specs=nano.specs \
           -T linker.ld -Wl,-Map=build/final.map
-nostdlib: khÃ´ng dÃ¹ng thÆ° viá»‡n tiÃªu chuáº©n (vÃ¬ há»‡ nhÃºng).

--specs=nano.specs: dÃ¹ng phiÃªn báº£n nhá» gá»n cá»§a stdlib.

-T linker.ld: dÃ¹ng linker script Ä‘á»ƒ gÃ¡n Ä‘á»‹a chá»‰.

-Wl,-Map=...: táº¡o file .map Ä‘á»ƒ debug Ä‘á»‹a chá»‰ vÃ¹ng nhá»›.

ğŸ“ 3. Cáº¥u trÃºc thÆ° má»¥c
SRC_DIR     := src
LIB_DIR     := lib
DRV_DIR     := $(SRC_DIR)/drivers
STARTUP_DIR := Startup
BUILD_DIR   := build
TÃ¡ch rÃµ rÃ ng cÃ¡c pháº§n:


ThÆ° má»¥c	Vai trÃ²
Startup/	File khá»Ÿi Ä‘á»™ng startup.c
lib/	CÃ¡c file thÆ° viá»‡n nhÆ° gpio.c, uart.c, ...
src/	main.c vÃ  logic chÃ­nh
src/drivers/	driver phá»¥ trá»£ nhÆ° log_info, temp.c
build/	ThÆ° má»¥c chá»©a .o, .elf, .bin
ğŸ§± 4. Danh sÃ¡ch source vÃ  Ä‘á»‘i tÆ°á»£ng
SRC_FILES := \
	$(STARTUP_DIR)/startup.c \
	$(SRC_DIR)/main.c \
	...
Táº­p há»£p táº¥t cáº£ cÃ¡c file .c trong project.

OBJS := $(patsubst %.c,$(BUILD_DIR)/%.o,$(SRC_FILES))
ğŸ“Œ DÃ²ng nÃ y ráº¥t hay: nÃ³ chuyá»ƒn táº¥t cáº£ *.c thÃ nh build/*.o báº±ng cÃ¡ch giá»¯ nguyÃªn path.

VÃ­ dá»¥:
src/main.c â†’ build/src/main.o
lib/gpio.c â†’ build/lib/gpio.o

Giá»¯ cáº¥u trÃºc thÆ° má»¥c y chang trong build/ â†’ cá»±c gá»n vÃ  sáº¡ch!

ğŸ¯ 5. Target chÃ­nh

TARGET_ELF := build/firmware.elf
TARGET_BIN := build/firmware.bin
Chá»‰ Ä‘á»‹nh output .elf vÃ  .bin.

ğŸ”„ 6. Rules
âœ… Rule chÃ­nh:
all: $(TARGET_BIN)
Cháº¡y make sáº½ build Ä‘áº¿n firmware.bin.

ğŸ“¦ BiÃªn dá»‹ch tá»«ng file .c â†’ .o
$(BUILD_DIR)/%.o: %.c
	@mkdir -p $(dir $@)
	$(CC) -c $(CFLAGS) $< -o $@
$<: lÃ  input file (%.c)

$@: lÃ  output file (build/%.o)

mkdir -p $(dir $@): tá»± Ä‘á»™ng táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³ â†’ ráº¥t tiá»‡n

ğŸ”— Link táº¥t cáº£ .o thÃ nh .elf

$(TARGET_ELF): $(OBJS) linker.ld
	$(CC) $(LDFLAGS) $(OBJS) -o $@
ğŸ”§ Táº¡o .bin tá»« .elf


$(TARGET_BIN): $(TARGET_ELF)
	$(OBJCOPY) -O binary $< $@
ğŸš€ Flash firmware


flash: $(TARGET_BIN)
	st-flash --reset write $(TARGET_BIN) 0x8000000
DÃ¹ng st-flash Ä‘á»ƒ náº¡p firmware vÃ o STM32 qua ST-Link.

ğŸ§¹ Clean:


clean:
	rm -rf $(BUILD_DIR)
XÃ³a háº¿t file Ä‘Ã£ build.

ğŸ§  Tá»•ng káº¿t

Pháº§n	Vai trÃ²
SRC_FILES + OBJS	Tá»± Ä‘á»™ng hÃ³a danh sÃ¡ch build
Rule $(BUILD_DIR)/%.o: %.c	Build thÃ´ng minh, táº¡o thÆ° má»¥c tá»± Ä‘á»™ng
make	Build hoÃ n toÃ n
make flash	Náº¡p chÆ°Æ¡ng trÃ¬nh
make clean	XÃ³a sáº¡ch file build

